<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AI 小咪 使用者授權條款</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
    }

    body {
      background-color: #f5f5f5;
      color: #222;
      padding: 16px;
    }

    .container {
      max-width: 768px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 32px);
    }

    .header {
      margin-bottom: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 12px;
      color: #777;
    }

    .eula-content {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #eee;
      background-color: #fafafa;
      overflow-y: auto;
      flex: 1;
    }

    .eula-content h1,
    .eula-content h2,
    .eula-content h3 {
      margin-top: 12px;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .eula-content h1 {
      font-size: 18px;
    }

    .eula-content h2 {
      font-size: 16px;
    }

    .eula-content h3 {
      font-size: 14px;
    }

    .eula-content p {
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 6px;
    }

    .eula-content ul {
      margin-left: 18px;
      margin-bottom: 6px;
    }

    .eula-content li {
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 2px;
    }

    .footer {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .buttons {
      display: flex;
      gap: 8px;
    }

    button {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #06c755; /* LINE 綠 */
      color: #fff;
    }

    .btn-secondary {
      background-color: #e0e0e0;
      color: #333;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      font-size: 12px;
      color: #666;
      min-height: 18px;
    }

    .status.error {
      color: #c62828;
    }

    .status.success {
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">AI 小咪 使用者授權條款</div>
      <div class="subtitle">最後更新日期：2025/xx/xx</div>
    </div>

    <div class="eula-content">
      <!-- EULA V2 內容開始 -->
      <h1>AI 小咪 使用者授權條款（EULA）V2（正式草案）</h1>

      <p>
        歡迎使用「AI 小咪」（以下稱「本服務」）。為保障您的權益，請於使用前詳閱本使用者授權條款（以下稱「本條款」）。當您開始使用本服務，即視為您已閱讀、了解並同意遵守本條款之全部內容。
      </p>

      <h2>一、服務內容定位</h2>
      <p>1. 本服務為健康記錄、飲食分析、生活建議與情緒陪伴之 AI 助手。</p>
      <p>2. 本服務並非醫療行為，不提供任何醫療診斷、治療、營養處方或專業醫療建議。</p>
      <p>3. AI 回覆可能因內容限制、模型推測特性而不完全正確，僅供參考，請勿取代專業醫療意見。</p>

      <h2>二、帳號與使用資格</h2>
      <p>1. 使用本服務需連結 LINE 官方帳號並授權取得必要資訊（例如：LINE User ID）。</p>
      <p>2. 用戶應確保提供資訊之正確性，如因錯誤資訊導致功能無法正常運作，本服務不負責賠償。</p>
      <p>3. 使用者應自行管理 LINE 帳號安全性；如遭未經授權使用，本服務不負相關責任。</p>

      <h2>三、個人資料蒐集、使用與保存</h2>
      <p>本服務將依《個人資料保護法》規定，於提供服務必要範圍內蒐集、處理及利用您的個人資料。</p>

      <h3>（一）蒐集項目包含：</h3>
      <ul>
        <li>1. 身份資訊：LINE User ID、暱稱。</li>
        <li>2. 健康紀錄：體重、精神狀態、睡眠紀錄、自我評估等。</li>
        <li>3. 飲食紀錄：照片、文字描述、AI 分析結果。</li>
        <li>4. 聊天內容：用於個人化建議與服務品質改善。</li>
        <li>5. 訂閱資料：會員方案、扣款狀態、有效期間（不包含信用卡資訊）。</li>
        <li>6. 系統資訊：瀏覽器、裝置資料、錯誤 Log。</li>
      </ul>

      <h3>（二）資料儲存與委外處理</h3>
      <ul>
        <li>1. 本服務資料主要儲存在 Cloudflare D1；必要時可能備份至其他安全存放之雲端服務。</li>
        <li>2. 本服務為提供 AI 功能，部分內容（如文字、照片）會送至 OpenAI 或等同之 AI 模型供分析使用。</li>
        <li>3. 付款資訊由 LINE Pay / 綠界（ECPay）負責，本服務不存取您的信用卡資料。</li>
      </ul>

      <h3>（三）資料保存期間</h3>
      <ul>
        <li>1. 身份資訊：使用期間及停止使用後 6 個月內。</li>
        <li>2. 健康紀錄、飲食紀錄：使用期間，停止後 30 天內刪除或匿名化。</li>
        <li>3. 聊天紀錄：預設保存 90 天，採滾動清除。</li>
        <li>4. 訂閱紀錄：依法務需求保存至少 5 年。</li>
      </ul>

      <p>
        您可依個資法行使查詢、請求複製、補充、更正、停止使用或要求刪除之權利。
      </p>

      <h2>四、AI 處理與資料使用聲明</h2>
      <p>1. 本服務之 AI 模型可能會接觸使用者輸入的健康紀錄與飲食內容，以產生分析與建議。</p>
      <p>2. 本服務不會使用您的個人資料訓練自有模型，除非事先明確徵求您的同意。</p>
      <p>3. 本服務使用第三方 AI（如 OpenAI）時，將依其資料處理政策執行。</p>

      <h2>五、訂閱方案與付費條款</h2>
      <p>1. 本服務提供免費會員、基本會員及進階會員（詳見官方公告）。</p>
      <p>2. 新用戶自啟用日起享有首週免費使用進階會員功能，期滿後自動轉為免費會員。</p>
      <p>3. 若您購買付費方案，將依 LINE Pay 或綠界提供之自動續訂機制進行扣款。</p>
      <p>4. 您可於續訂日前取消訂閱；取消後本期服務會持續至到期日。</p>
      <p>5. 由於本服務屬數位內容，一經扣款即視為使用，原則上不提供退款。</p>
      <p>6. 若因不可抗力或系統原因導致服務中斷，本服務將以合理方式提供補償（如延長使用期限）。</p>

      <h2>六、使用限制</h2>
      <p>您不得進行下列行為：</p>
      <ul>
        <li>1. 進行違法用途或利用本服務散布不當內容。</li>
        <li>2. 嘗試逆向工程、破解、修改或干擾本服務系統。</li>
        <li>3. 發送異常大量訊息、惡意操作或干擾其他使用者體驗。</li>
      </ul>
      <p>如違反上述規範，本服務得在不另行通知之情況下限制或終止使用資格。</p>

      <h2>七、智慧財產權</h2>
      <p>1. 本服務所有內容與技術均受著作權法、商標法、專利法等保護。</p>
      <p>2. 未經授權，使用者不得複製、公開傳輸、散布、出售或提供衍生作品。</p>

      <h2>八、風險與免責聲明</h2>
      <p>1. AI 回覆基於模型推論，可能不完整、不準確或誤解上下文，本服務不保證正確性。</p>
      <p>2. 本服務內容僅供參考，不具醫療、營養師或其他專業建議效力。</p>
      <p>3. 使用者因依本服務內容作出的任何決策或行為，其風險與後果由使用者自行承擔。</p>
      <p>4. 本服務不對因第三方服務（LINE、OpenAI、Cloudflare 等）故障或中斷造成的損失負責。</p>

      <h2>九、服務變更、暫停與終止</h2>
      <p>1. 本服務得因維護、更新、法規要求或其他必要原因變更或暫停服務。</p>
      <p>2. 本服務保留修改本條款之權利，並以公告方式提示；您於修訂後使用本服務，即視為同意新條款。</p>
      <p>3. 若服務永久終止，本服務將依個資法與資訊安全要求刪除或匿名化所有個人資料。</p>

      <h2>十、準據法與管轄</h2>
      <p>本條款以中華民國法律為準據法，如有爭議，以台灣台北地方法院為第一審管轄法院。</p>
      <!-- EULA V2 內容結束 -->
    </div>

    <div class="footer">
      <div class="buttons">
        <button id="btn-decline" class="btn-secondary">不同意</button>
        <button id="btn-accept" class="btn-primary">同意並繼續</button>
      </div>
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const API_ENDPOINT = "/api/eula/consent"; // TODO: 換成你實際的後端 API

    const statusEl = document.getElementById("status");
    const btnAccept = document.getElementById("btn-accept");
    const btnDecline = document.getElementById("btn-decline");

    function setStatus(message, type) {
      statusEl.textContent = message || "";
      statusEl.className = "status" + (type ? " " + type : "");
    }

    function setLoading(isLoading) {
      btnAccept.disabled = isLoading;
      btnDecline.disabled = isLoading;
    }

    async function initLiff() {
      try {
        await liff.init({ liffId: "2008550298-O2v7brYe" });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        setStatus("請閱讀條款，並選擇是否同意。");
      } catch (err) {
        console.error("LIFF init error:", err);
        setStatus("LIFF 初始化失敗，請稍後再試。", "error");
      }
    }

    async function sendConsent(agreed) {
      setLoading(true);
      setStatus("處理中，請稍候…");

      try {
        // 你可以選擇用 getProfile 或 getIDToken 等方式識別使用者
        const profile = await liff.getProfile();
        const context = liff.getContext ? liff.getContext() : null;

        const payload = {
          agreed,
          eulaVersion: "V2",
          agreedAt: new Date().toISOString(),
          lineUserId: profile && profile.userId,
          displayName: profile && profile.displayName,
          liffContext: context,
        };

        const res = await fetch(API_ENDPOINT, {

